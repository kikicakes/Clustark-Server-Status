<script>
  const API_SERVERS = [
    { id: 712734, label: "The Island" },
    { id: 712735, label: "Scorched Earth" },
    { id: 739093, label: "Aberration" },
    { id: 713067, label: "Extinction" },
    { id: 713549, label: "Genesis Part 1" },
    { id: 1001651, label: "Genesis Part 2" },
    { id: 712733, label: "Ragnarok" },
    { id: 833827, label: "The Center" },
    { id: 712731, label: "Crystal Isles" },
    { id: 712730, label: "Valguero" },
    { id: 1493786, label: "Lost Island" },
    { id: 1966993, label: "Fjordur" }
  ];

  let mappings = {};
  let allPlayersSet = new Set();

  function fetchAllPlayers() {
    return new Promise((resolve) => {
      let playersSet = new Set();
      let completed = 0;

      API_SERVERS.forEach(server => {
        const url = `https://corsproxy.io/?https://api.trackyserver.com/widget/index.php?id=${server.id}`;
        console.log(`Fetching players for server: ${server.label} (${server.id})`);
        $.getJSON(url)
          .done(data => {
            console.log(`Data received from ${server.label}:`, data);
            if (Array.isArray(data.playerslist)) {
              data.playerslist.forEach(p => playersSet.add(p.name));
            } else {
              console.warn(`${server.label} has no playerslist array.`);
            }
          })
          .fail((jqxhr, textStatus, error) => {
            console.error(`Failed to fetch players for server ${server.label}: ${textStatus}, ${error}`);
          })
          .always(() => {
            completed++;
            if (completed === API_SERVERS.length) {
              console.log('All server fetches complete. Unique players:', playersSet);
              resolve(playersSet);
            }
          });
      });
    });
  }

  function populatePlayerDropdown(unmappedPlayers) {
    const $select = $('#playerSelect');
    $select.empty();

    if (unmappedPlayers.length === 0) {
      $select.append('<option value="">No unmapped players found</option>');
      return;
    }

    $select.append('<option value="">-- Select a player --</option>');
    unmappedPlayers.forEach(name => {
      $select.append(`<option value="${name}">${name}</option>`);
    });
  }

  function renderMappings() {
    const container = $('#mappingsContainer');
    container.empty();

    if (Object.keys(mappings).length === 0) {
      container.html('<p>No mappings yet.</p>');
      return;
    }

    for (const [steamName, info] of Object.entries(mappings)) {
      const charName = info.character || '';
      const div = $(`
        <div class="card bg-secondary text-white mb-2 p-2 d-flex flex-wrap align-items-center justify-content-between">
          <div><strong>Steam/Epic:</strong> ${steamName}</div>
          <div>
            <input type="text" class="form-control form-control-sm me-2 mb-1 mb-md-0 characterInput" data-steam="${steamName}" placeholder="Character Name" value="${charName}" style="width: 180px; display: inline-block;" />
            <button class="btn btn-danger btn-sm ms-2 removeMappingBtn" data-steam="${steamName}">Remove</button>
          </div>
        </div>
      `);
      container.append(div);
    }
  }

  function refreshUnmappedDropdown() {
    const unmappedPlayers = Array.from(allPlayersSet).filter(name => !(name in mappings));
    unmappedPlayers.sort((a,b) => a.toLowerCase().localeCompare(b.toLowerCase()));
    populatePlayerDropdown(unmappedPlayers);
  }

  $(document).ready(() => {
    $.getJSON('mappings.json')
      .done(data => {
        mappings = data;
        console.log('Loaded mappings.json:', mappings);
      })
      .fail(() => {
        mappings = {};
        alert('Failed to load mappings.json. Starting with empty mappings.');
      })
      .always(() => {
        renderMappings();

        fetchAllPlayers().then(playersSet => {
          allPlayersSet = playersSet;
          if(allPlayersSet.size === 0) {
            alert('No players found on any servers.');
            $('#playerSelect').empty().append('<option value="">No players found</option>');
          } else {
            refreshUnmappedDropdown();
          }
        });
      });

    $('#addMappingBtn').click(() => {
      const steamName = $('#playerSelect').val();
      const characterName = $('#characterName').val().trim();

      if (!steamName) {
        alert('Please select a Steam/Epic name from the dropdown.');
        return;
      }
      if (!characterName) {
        alert('Please enter a character name.');
        return;
      }

      mappings[steamName] = { character: characterName };

      renderMappings();
      refreshUnmappedDropdown();

      $('#playerSelect').val('');
      $('#characterName').val('');
    });

    $('#mappingsContainer').on('click', '.removeMappingBtn', function() {
      const steamName = $(this).data('steam');
      if (confirm(`Remove mapping for ${steamName}?`)) {
        delete mappings[steamName];
        renderMappings();
        refreshUnmappedDropdown();
      }
    });

    $('#mappingsContainer').on('input', '.characterInput', function() {
      const steamName = $(this).data('steam');
      const val = $(this).val().trim();
      if (steamName in mappings) {
        mappings[steamName].character = val;
      }
    });

    $('#saveMappingsBtn').click(() => {
      const jsonStr = JSON.stringify(mappings, null, 2);
      prompt('Copy your mappings JSON below:', jsonStr);
    });
  });
</script>
