<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ClustARK Server Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container py-4">
    <h1 class="text-center mb-4">ðŸŽ® ClustARK Server Status</h1>
    <div id="serverStatusContainer" class="row gy-4"></div>
  </div>

  <script>
    const API_SERVERS = [
      { id: 1001651, label: "Gen 2" },
      { id: 712733, label: "Ragnarok" },
      { id: 712734, label: "The Island" },
      { id: 1493786, label: "Lost Island" },
      { id: 1966993, label: "Fjordur" },
      { id: 712731, label: "Crystal Isles" },
      { id: 739093, label: "Aberration" },
      { id: 712730, label: "Valguero" },
      { id: 712735, label: "Scorched Earth" },
      { id: 713067, label: "Extinction" },
      { id: 713549, label: "Genesis 1" },
      { id: 833827, label: "The Center" }
    ];

    function createServerCard(data, mapping) {
      const $card = $(`
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card text-bg-dark h-100">
            <div class="card-body">
                <h5 class="card-title server-title">${data.name || "Unknown Server"}</h5>
              <p class="card-text">
                <strong>Map:</strong> ${data.map || "Unknown"}<br>
                <strong>Players:</strong> ${data.playerscount ?? "Offline"}
              </p>
              <div class="table-responsive">
                <table class="table table-dark table-bordered table-sm mb-0">
                  <thead>
                    <tr>
                      <th>Steam/Epic Name</th>
                      <th>Character Name</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${
                      Array.isArray(data.playerslist) && data.playerslist.length > 0
                        ? data.playerslist.map(p => {
                            const normalized = p.name.trim().toLowerCase();
                            const match = Object.entries(mapping).find(
                              ([key]) => key.trim().toLowerCase() === normalized
                            )?.[1] || {};
                            const characterName = match.character || '';
                            return `
                              <tr>
                                <td>${p.name}</td>
                                <td>${characterName}</td>
                              </tr>
                            `;
                          }).join('')
                        : '<tr><td colspan="2">No players connected</td></tr>'
                    }
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `);
      $('#serverStatusContainer').append($card);
    }

    function loadServers(mapping) {
      $('#serverStatusContainer').empty();
      API_SERVERS.forEach(server => {
        const url = `https://corsproxy.io/?https://api.trackyserver.com/widget/index.php?id=${server.id}`;
        $.getJSON(url)
          .done(data => createServerCard(data, mapping))
          .fail(() => {
            $('#serverStatusContainer').append(`
              <div class="col-12 col-md-6 col-lg-4">
                <div class="card text-bg-danger h-100">
                  <div class="card-body">
                    <h5 class="card-title">${server.label}</h5>
                    <p class="card-text">Failed to load server data.</p>
                  </div>
                </div>
              </div>
            `);
          });
      });
    }

    $(document).ready(() => {
        $.getJSON('mappings.json')
  .done(function(mapping) {
    loadServers(mapping);
    setInterval(() => loadServers(mapping), 30000);
  })
  .fail(() => {
    console.warn('Failed to load mappings.json. Proceeding with empty mapping.');
    const emptyMapping = {};
    loadServers(emptyMapping);
    setInterval(() => loadServers(emptyMapping), 30000);
  });

    });
  </script>
</body>
</html>
