<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ClustARK Gen2 Server Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <div class="card p-4">
      <h2 class="mb-4">ðŸŽ® ClustARK Gen2 Server Status</h2>
      <p><strong>Server Name:</strong> <span id="serverName">Loadingâ€¦</span></p>
      <p><strong>Map:</strong> <span id="mapName">Loadingâ€¦</span></p>
      <p><strong>Players:</strong> <span id="playerCount">Loadingâ€¦</span></p>
      <h5 class="mt-4">Connected Players</h5>

      <div class="table-responsive">
        <table class="table table-dark table-striped table-bordered">
          <thead>
            <tr>
              <th>Steam/Epic Name</th>
              <th>Character Name</th>
              <!-- <th>Tribe Name</th> -->
            </tr>
          </thead>
          <tbody id="playerTable">
            <tr><td colspan="2">Loadingâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://corsproxy.io/?https://api.trackyserver.com/widget/index.php?id=1001651';

    function refreshServerData(mapping) {
      $.getJSON(API_URL)
        .done(data => {
          $('#serverName').text(data.name || 'Unknown');
          $('#mapName').text(data.map || 'Unknown');
          $('#playerCount').text(data.playerscount ?? 'Offline');

          const $table = $('#playerTable').empty();

          if (Array.isArray(data.playerslist) && data.playerslist.length > 0) {
            data.playerslist.forEach(p => {
              const normalized = p.name.trim().toLowerCase();
              let matchedEntry = null;

              for (const [key, value] of Object.entries(mapping)) {
                if (key.trim().toLowerCase() === normalized) {
                  matchedEntry = value;
                  break;
                }
              }

              const characterName = matchedEntry?.character || '';
              // const tribeName = matchedEntry?.tribe || '';

              $table.append(`
                <tr>
                  <td>${p.name}</td>
                  <td>${characterName}</td>
                  <!-- <td>${tribeName}</td> -->
                </tr>
              `);
            });
          } else {
            $table.append('<tr><td colspan="2">No players connected</td></tr>');
          }
        })
        .fail(() => {
          $('#serverName, #mapName, #playerCount').text('Error');
          $('#playerTable').html('<tr><td colspan="2" class="bg-danger text-white">Failed to load player list</td></tr>');
        });
    }

    $(document).ready(() => {
      $.getJSON('mappings.json', function(mapping) {
        refreshServerData(mapping);
        setInterval(() => refreshServerData(mapping), 30000);
      }).fail(() => {
        alert('Failed to load mappings.json');
      });
    });
  </script>
</body>
</html>